{% extends 'invoices/manage/base.html' %}
{% load static %}

{% block title %}æŠ¥è´¦è¯¦æƒ… - 525å®éªŒå®¤å‘ç¥¨ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
{% csrf_token %}
<div class="page-header">
    <h1>æŠ¥è´¦è¯¦æƒ…</h1>
    <div class="page-actions">
        <a href="{% url 'invoices:manage_reimbursement_list' %}" class="btn">
            <span class="icon">â†</span>è¿”å›åˆ—è¡¨
        </a>
        <button id="delete-btn" class="btn btn-danger" onclick="deleteRecord({{ record.id }})">
            <span class="icon">ğŸ—‘ï¸</span>åˆ é™¤
        </button>
        {% if record.status == 'SUBMITTED' %}
        <button class="btn btn-primary" onclick="markAsCompleted({{ record.id }})">
            <span class="icon">âœ“</span>æ ‡è®°ä¸ºå·²æŠ¥è´¦
        </button>
        {% endif %}
    </div>
</div>

<div class="detail-grid">
    <div class="card">
        <div class="card-header">
            <h3>åŸºæœ¬ä¿¡æ¯</h3>
        </div>
        <div class="card-body">
            <div class="info-grid">
                <div class="info-item">
                    <label>æŠ¥è´¦ç±»å‹</label>
                    <div>{{ record.get_record_type_display }}</div>
                </div>
                <div class="info-item">
                    <label>æŠ¥è´¦æ—¥æœŸ</label>
                    <div>{{ record.reimbursement_date|date:"Y-m-d" }}</div>
                </div>
                <div class="info-item">
                    <label>æ€»é‡‘é¢</label>
                    <div>Â¥{{ record.total_amount|floatformat:2 }}</div>
                </div>
                <div class="info-item">
                    <label>çŠ¶æ€</label>
                    <div>
                        <span class="status-badge {{ record.status|lower }}">
                            {{ record.get_status_display }}
                        </span>
                    </div>
                </div>
                <div class="info-item full">
                    <label>å¤‡æ³¨</label>
                    <div>{{ record.remarks|default:"æ— " }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>å…³è”å‘ç¥¨</h3>
            <div class="card-actions">
                <button class="btn btn-sm" onclick="showAddInvoiceModal()">
                    <span class="icon">â•</span>æ–°å¢å…³è”å‘ç¥¨
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteSelectedInvoices()" id="batchDeleteBtn" style="display: none;">
                    <span class="icon">ğŸ—‘ï¸</span>æ‰¹é‡åˆ é™¤
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>å‘ç¥¨å·</th>
                            <th>è´¹ç”¨ç±»å‹</th>
                            <th>é‡‘é¢</th>
                            <th>æŠ¥é”€äºº</th>
                            <th>å‘ç¥¨æ—¥æœŸ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for invoice in invoices %}
                        <tr>
                            <td>
                                <input type="checkbox" name="invoice_ids[]" value="{{ invoice.id }}" 
                                       class="invoice-checkbox" onchange="updateBatchDeleteBtn()">
                            </td>
                            <td>{{ invoice.invoice_number }}</td>
                            <td>{{ invoice.expense_type.name }}</td>
                            <td>Â¥{{ invoice.amount|floatformat:2 }}</td>
                            <td>{{ invoice.reimbursement_person }}</td>
                            <td>{{ invoice.invoice_date|date:"Y-m-d" }}</td>
                            <td>
                                <button class="btn-icon" onclick="removeInvoice({{ invoice.id }})" 
                                        title="ç§»é™¤å‘ç¥¨">
                                    ğŸ—‘ï¸
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="empty-message">æš‚æ— å…³è”å‘ç¥¨</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢å…³è”å‘ç¥¨æ¨¡æ€æ¡† -->
<div id="addInvoiceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ–°å¢å…³è”å‘ç¥¨</h3>
            <button type="button" class="close-btn" onclick="closeAddInvoiceModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="addInvoiceForm" method="post" action="{{ URLS.addInvoice }}">
                {% csrf_token %}
                <div class="form-group">
                    <label>é€‰æ‹©å‘ç¥¨*</label>
                    <div class="invoice-selector">
                        <!-- è¿™é‡Œå°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½æœªæŠ¥è´¦çš„å‘ç¥¨åˆ—è¡¨ -->
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">æ·»åŠ å‘ç¥¨</button>
                    <button type="button" class="btn" onclick="closeAddInvoiceModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.page-actions {
    display: flex;
    gap: 15px;
    align-items: center;
}

.page-actions .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    height: 36px;
    margin-bottom: 0px;
}

.page-actions .icon {
    font-size: 16px;
}

.detail-grid .card {
    margin: 0;
    width: 100%;
}

.detail-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
    margin-top: 20px;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    padding: 20px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.info-item.full {
    grid-column: 1 / -1;
}

.info-item label {
    color: #7EAEFF;
    font-size: 14px;
}

.card-header {
    padding: 15px 20px;
    border-bottom: 1px solid rgba(0, 198, 255, 0.1);
}

.card-header h3 {
    margin: 0;
    color: #00C6FF;
    font-size: 18px;
}

.card-body {
    padding: 0;
}

/* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
.table-responsive {
    margin: 0;
    padding: 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background: rgba(13, 25, 76, 0.5);
    color: #7EAEFF;
    font-weight: normal;
    text-align: left;
    padding: 12px;
}

td {
    padding: 12px;
    border-bottom: 1px solid rgba(0, 198, 255, 0.1);
}

tr:last-child td {
    border-bottom: none;
}

tr:hover td {
    background: rgba(0, 198, 255, 0.05);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-actions {
    display: flex;
    gap: 10px;
}

.btn-sm {
    padding: 4px 12px;
    height: 28px;
    font-size: 13px;
}

.btn-danger {
    background: rgba(244, 67, 54, 0.1);
    border-color: rgba(244, 67, 54, 0.3);
    color: #F44336;
}

.btn-danger:hover {
    background: rgba(244, 67, 54, 0.2);
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #0D194C;
    border-radius: 8px;
    width: 90%;
    /* max-width: 600px; */
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid rgba(0, 198, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0px;
}

.modal-body {
    padding: 0px 20px 0px;
}

.close-btn {
    background: none;
    border: none;
    color: #7EAEFF;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    margin: 0;
}

.close-btn:hover {
    color: #00C6FF;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    color: #7EAEFF;
    font-size: 14px;
}

.form-group input,
.form-group select {
    /* width: 5%; */
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.form-actions button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.form-actions button.btn-primary {
    background: rgba(0, 198, 255, 0.2);
    color: #00C6FF;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    const URLS = {
        reimbursementComplete: '{% url "invoices:manage_reimbursement_complete" pk=record.id %}',
        addInvoice: '{% url "invoices:manage_reimbursement_add_invoice" pk=record.id %}',
        removeInvoice: '{% url "invoices:manage_reimbursement_remove_invoice" pk=record.id invoice_pk=0 %}',
        reimbursementDelete: '{% url "invoices:manage_reimbursement_delete" pk=record.id %}',
        unreimbursedInvoices: '/manage/reimbursement/unreimbursed-invoices/'
    };
</script>
<script>
async function markAsCompleted(id) {
    if (!confirm('ç¡®å®šå°†æ­¤è®°å½•æ ‡è®°ä¸ºå·²æŠ¥è´¦ï¼Ÿ')) return;
    
    try {
        const response = await fetch(URLS.reimbursementComplete.replace('0', id), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

function showAddInvoiceModal() {
    const modal = document.getElementById('addInvoiceModal');
    modal.classList.add('show');
    loadAvailableInvoices();
}

function closeAddInvoiceModal() {
    const modal = document.getElementById('addInvoiceModal');
    modal.classList.remove('show');
}

async function loadAvailableInvoices() {
    try {
        const response = await fetch(URLS.unreimbursedInvoices);
        const data = await response.json();
        console.log(data);
        
        const container = document.querySelector('#addInvoiceModal .invoice-selector');
        container.innerHTML = `
            <div class="filter-bar" style="margin-bottom: 15px;">
                <input type="text" id="searchPerson" placeholder="æœç´¢æŠ¥é”€äºº..." 
                       onkeyup="filterInvoices()" class="search-input">
                <input type="date" id="searchDate" onchange="filterInvoices()" 
                       class="date-input">
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="selectAllUnreimbursed" onchange="toggleSelectAllUnreimbursed()">
                            </th>
                            <th>å‘ç¥¨å·</th>
                            <th>å‘ç¥¨ç±»å‹</th>
                            <th>è´¹ç”¨ç±»å‹</th>
                            <th>é‡‘é¢</th>
                            <th>æŠ¥é”€äºº</th>
                            <th>å‘ç¥¨æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceTableBody">
                        ${data.invoices.map(invoice => `
                            <tr>
                                <td>
                                    <input type="checkbox" name="invoice_ids[]" value="${invoice.id}" 
                                           class="unreimbursed-checkbox">
                                </td>
                                <td>${invoice.invoice_number}</td>
                                <td>${invoice.invoice_type_display}</td>
                                <td>${invoice.expense_type_name}</td>
                                <td>Â¥${typeof invoice.amount === 'number' ? 
                                    invoice.amount.toFixed(2) : 
                                    parseFloat(invoice.amount).toFixed(2)}</td>
                                <td>${invoice.reimbursement_person}</td>
                                <td>${invoice.invoice_date}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (error) {
        console.error('Error loading invoices:', error);
        alert('åŠ è½½å‘ç¥¨åˆ—è¡¨å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

function toggleSelectAllUnreimbursed() {
    const selectAll = document.getElementById('selectAllUnreimbursed');
    const checkboxes = document.querySelectorAll('.unreimbursed-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = selectAll.checked);
}

function deleteRecord(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è®°å½•å—ï¼Ÿ')) return;
    window.location.href = URLS.reimbursementDelete.replace('0', id);
}

// å¤„ç†æ·»åŠ å‘ç¥¨è¡¨å•æäº¤
document.getElementById('addInvoiceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // è·å–é€‰ä¸­çš„å‘ç¥¨ID
    const selectedInvoices = Array.from(
        document.querySelectorAll('#addInvoiceModal input[name="invoice_ids[]"]:checked')
    ).map(cb => cb.value);
    
    if (selectedInvoices.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å‘ç¥¨');
        return;
    }
    
    try {
        const formData = new FormData();
        selectedInvoices.forEach(id => formData.append('invoice_ids[]', id));
        
        const response = await fetch(URLS.addInvoice, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert('æ·»åŠ å¤±è´¥ï¼š' + (data.error || 'è¯·é‡è¯•'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
});

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.invoice-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = selectAll.checked);
    updateBatchDeleteBtn();
}

function updateBatchDeleteBtn() {
    const checkboxes = document.querySelectorAll('.invoice-checkbox:checked');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    batchDeleteBtn.style.display = checkboxes.length > 0 ? 'inline-flex' : 'none';
}

async function removeInvoice(invoiceId) {
    if (!confirm('ç¡®å®šè¦ç§»é™¤æ­¤å‘ç¥¨å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(URLS.removeInvoice.replace('0', invoiceId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

async function deleteSelectedInvoices() {
    const selectedIds = Array.from(document.querySelectorAll('.invoice-checkbox:checked'))
        .map(checkbox => checkbox.value);
    
    if (!selectedIds.length || !confirm('ç¡®å®šè¦ç§»é™¤é€‰ä¸­çš„å‘ç¥¨å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(URLS.batchRemoveInvoices, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ invoice_ids: selectedIds })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}
</script>
{% endblock %}
