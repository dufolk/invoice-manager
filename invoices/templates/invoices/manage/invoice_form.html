{% extends 'invoices/manage/base.html' %}

{% block title %}{% if invoice %}ç¼–è¾‘{% else %}æ·»åŠ {% endif %}å‘ç¥¨ - 525å®éªŒå®¤å‘ç¥¨ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{% if invoice %}ç¼–è¾‘{% else %}æ·»åŠ {% endif %}å‘ç¥¨</h1>
</div>

<div class="card">
    <form method="post" enctype="multipart/form-data" class="form">
        {% csrf_token %}
        <div class="form-grid">
            <div class="form-group">
                <label for="invoice_number">å‘ç¥¨å·*</label>
                <input type="text" id="invoice_number" name="invoice_number" required
                       value="{{ invoice.invoice_number|default:'' }}">
            </div>

            <div class="form-group">
                <label for="invoice_type">å‘ç¥¨ç±»å‹*</label>
                <select id="invoice_type" name="invoice_type" required>
                    <option value="">è¯·é€‰æ‹©å‘ç¥¨ç±»å‹</option>
                    <option value="DAILY" {% if invoice.invoice_type == 'DAILY' %}selected{% endif %}>æ—¥å¸¸å‘ç¥¨</option>
                    <option value="TRAVEL" {% if invoice.invoice_type == 'TRAVEL' %}selected{% endif %}>å·®æ—…å‘ç¥¨</option>
                </select>
            </div>

            <div class="form-group">
                <label for="expense_type">è´¹ç”¨ç±»å‹*</label>
                <select id="expense_type" name="expense_type" required>
                    <option value="">è¯·é€‰æ‹©è´¹ç”¨ç±»å‹</option>
                    {% for type in expense_types %}
                        {% if invoice %}
                            {% if invoice.invoice_type == 'DAILY' and type.category != 'TRAVEL' or invoice.invoice_type == 'TRAVEL' and type.category != 'DAILY' %}
                                <option value="{{ type.id }}" {% if invoice.expense_type_id == type.id %}selected{% endif %}>
                                    {{ type.name }}
                                </option>
                            {% endif %}
                        {% else %}
                            {% if invoice_type == 'DAILY' and type.category != 'TRAVEL' or invoice_type == 'TRAVEL' and type.category != 'DAILY' %}
                                <option value="{{ type.id }}" {% if invoice.expense_type_id == type.id %}selected{% endif %}>
                                    {{ type.name }}
                                </option>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="amount">é‡‘é¢*</label>
                <input type="number" id="amount" name="amount" step="0.01" required
                       value="{{ invoice.amount|default:'' }}">
            </div>

            <div class="form-group">
                <label for="invoice_date">å‘ç¥¨æ—¥æœŸ*</label>
                <input type="date" id="invoice_date" name="invoice_date" required
                       value="{{ invoice.invoice_date|date:'Y-m-d'|default:'' }}">
            </div>

            <div class="form-group">
                <label for="reimbursement_person">æŠ¥é”€äºº*</label>
                <input type="text" id="reimbursement_person" name="reimbursement_person" required
                       value="{{ invoice.reimbursement_person|default:'' }}">
            </div>

            <div class="form-group full-width">
                <label for="details">æŠ¥é”€å†…å®¹æ˜ç»†</label>
                <textarea id="details" name="details" rows="4">{{ invoice.details|default:'' }}</textarea>
            </div>

            <div class="form-group full-width">
                <label for="remarks">å¤‡æ³¨</label>
                <textarea id="remarks" name="remarks" rows="4">{{ invoice.remarks|default:'' }}</textarea>
            </div>

            <div class="form-group">
                <label for="file">å‘ç¥¨æ–‡ä»¶</label>
                <div class="file-upload-group">
                    {% csrf_token %}
                    <input type="file" id="file" name="file" accept="image/*,application/pdf" {% if not invoice %}required{% endif %}>
                    <button type="button" id="parse-btn" class="btn btn-primary">
                        <span class="icon">ğŸ“„</span>è§£æ
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label for="attachment">é™„ä»¶</label>
                <div class="file-upload-group">
                    <input type="file" id="attachment" name="attachment">
                    {% if invoice.attachment %}
                    <div class="current-attachment">
                        <a href="{{ invoice.attachment.url }}" target="_blank" class="btn btn-link">
                            <span class="icon">ğŸ“</span>æŸ¥çœ‹å½“å‰é™„ä»¶
                        </a>
                    </div>
                    {% endif %}
                </div>
                <div class="help-text">å¯ä¸Šä¼ ä»»æ„ç±»å‹çš„é™„ä»¶æ–‡ä»¶</div>
            </div>
        </div>

        <div id="travel_details" style="display: none;">
            <h3>å·®æ—…ä¿¡æ¯</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="traveler">å‡ºå·®äºº*</label>
                    <input type="text" id="traveler" name="traveler" 
                           value="{{ invoice.travelinvoice.traveler|default:'' }}">
                </div>

                <div class="form-group">
                    <label for="start_date">å¼€å§‹æ—¥æœŸ*</label>
                    <input type="date" id="start_date" name="start_date"
                           value="{{ invoice.travelinvoice.start_date|date:'Y-m-d'|default:'' }}">
                </div>

                <div class="form-group">
                    <label for="end_date">ç»“æŸæ—¥æœŸ*</label>
                    <input type="date" id="end_date" name="end_date"
                           value="{{ invoice.travelinvoice.end_date|date:'Y-m-d'|default:'' }}">
                </div>

                <div class="form-group">
                    <label for="destination">å‡ºå·®åœ°ç‚¹*</label>
                    <input type="text" id="destination" name="destination"
                           value="{{ invoice.travelinvoice.destination|default:'' }}">
                </div>
            </div>

            <div id="transport_details" class="detail-section" style="display: none;">
                <h4>äº¤é€šæ˜ç»†</h4>
                <div class="transport-item">
                    <div class="form-group">
                        <label>äº¤é€šç±»å‹*</label>
                        <select name="transport_type" class="transport-type" required>
                            <option value="TRAIN">é«˜é“</option>
                            <option value="PLANE">é£æœº</option>
                            <option value="BUS">æ±½è½¦</option>
                            <option value="TAXI">å‡ºç§Ÿè½¦</option>
                            <option value="OTHER">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å‡ºå‘æ—¶é—´*</label>
                        <input type="datetime-local" name="departure_time" required>
                    </div>
                    <div class="form-group">
                        <label>å‡ºå‘åœ°*</label>
                        <input type="text" name="departure_place" required>
                    </div>
                    <div class="form-group">
                        <label>ç›®çš„åœ°*</label>
                        <input type="text" name="destination" required>
                    </div>
                    <div class="form-group seat-type-group">
                        <label>åº§ä½ç±»å‹*</label>
                        <select name="seat_type" class="seat-type" required>
                            <!-- é€‰é¡¹å°†ç”± JavaScript åŠ¨æ€å¡«å…… -->
                        </select>
                    </div>
                </div>
            </div>

            <div id="accommodation_details" class="detail-section" style="display: none;">
                <h4>ä½å®¿æ˜ç»†</h4>
                <div class="accommodation-item">
                    <div class="form-group">
                        <label>å…¥ä½æ—¥æœŸ*</label>
                        <input type="date" name="check_in_date" required>
                    </div>
                    <div class="form-group">
                        <label>ç¦»åº—æ—¥æœŸ*</label>
                        <input type="date" name="check_out_date" required>
                    </div>
                    <div class="form-group">
                        <label>é…’åº—åç§°*</label>
                        <input type="text" name="hotel_name" required>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            <a href="{% url 'invoices:manage_invoice_list' %}" class="btn">å–æ¶ˆ</a>
        </div>
    </form>
</div>

<!-- è§£æç¡®è®¤æ¨¡æ€æ¡† -->
<div id="parse-confirm-modal" class="modal parse-modal">
    <div class="modal-content">
        <button type="button" class="close-btn" id="close-parse">Ã—</button>
        <h3>å‘ç¥¨è§£æç»“æœç¡®è®¤</h3>
        <div class="parse-result">
            <div class="result-item">
                <label>å‘ç¥¨å·ç ï¼š</label>
                <span id="modal-invoice-num"></span>
            </div>
            <div class="result-item">
                <label>å‘ç¥¨é‡‘é¢ï¼š</label>
                <span id="modal-amount"></span>
            </div>
            <div class="result-item">
                <label>å‘ç¥¨æ—¥æœŸï¼š</label>
                <span id="modal-date"></span>
            </div>
            <div class="result-item">
                <label>æŠ¥é”€å†…å®¹ï¼š</label>
                <span id="modal-details"></span>
            </div>
            <div class="result-item">
                <label>å¤‡æ³¨ï¼š</label>
                <span id="modal-remarks"></span>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-primary" id="confirm-parse">ç¡®è®¤å¡«å……</button>
            <button type="button" class="btn" id="cancel-parse">å–æ¶ˆ</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const invoiceTypeSelect = document.getElementById('invoice_type');
    const expenseTypeSelect = document.getElementById('expense_type');
    const travelDetails = document.getElementById('travel_details');
    const transportDetails = document.getElementById('transport_details');
    const accommodationDetails = document.getElementById('accommodation_details');

    function updateExpenseTypeAndDetails() {
        const isTravel = invoiceTypeSelect.value === 'TRAVEL';
        
        // æ˜¾ç¤º/éšè—å·®æ—…ä¿¡æ¯éƒ¨åˆ†
        travelDetails.style.display = isTravel ? 'block' : 'none';
        
        // è·å–æ‰€æœ‰å·®æ—…ç›¸å…³çš„å¿…å¡«å­—æ®µ
        const travelInputs = travelDetails.querySelectorAll('input[required], select[required]');
        
        // æ ¹æ®æ˜¯å¦æ˜¯å·®æ—…å‘ç¥¨è®¾ç½®å¿…å¡«å±æ€§
        travelInputs.forEach(input => {
            if (isTravel) {
                input.setAttribute('required', '');
            } else {
                input.removeAttribute('required');
            }
        });
        
        // è·å–æ‰€æœ‰è´¹ç”¨ç±»å‹é€‰é¡¹
        const options = expenseTypeSelect.options;
        
        // æ¸…ç©ºå½“å‰é€‰é¡¹
        expenseTypeSelect.innerHTML = '';
        
        // æ ¹æ®å‘ç¥¨ç±»å‹ç­›é€‰å¹¶æ·»åŠ å¯¹åº”çš„è´¹ç”¨ç±»å‹é€‰é¡¹
        {% for type in expense_types %}
        if ((isTravel && "{{ type.category }}" === "TRAVEL") || 
            (!isTravel && "{{ type.category }}" !== "TRAVEL")) {
            const option = new Option("{{ type.name }}", "{{ type.id }}");
            expenseTypeSelect.add(option);
        }
        {% endfor %}

        // å¦‚æœæ˜¯å·®æ—…å‘ç¥¨ï¼Œç›‘å¬è´¹ç”¨ç±»å‹å˜åŒ–
        if (isTravel) {
            expenseTypeSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const typeName = selectedOption.text;
                
                // æ ¹æ®è´¹ç”¨ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„æ˜ç»†éƒ¨åˆ†
                const showTransport = typeName === 'äº¤é€šè´¹';
                const showAccommodation = typeName === 'ä½å®¿è´¹';
                
                transportDetails.style.display = showTransport ? 'block' : 'none';
                accommodationDetails.style.display = showAccommodation ? 'block' : 'none';
                
                // è®¾ç½®æ˜ç»†å­—æ®µçš„å¿…å¡«çŠ¶æ€
                const transportInputs = transportDetails.querySelectorAll('input, select');
                const accommodationInputs = accommodationDetails.querySelectorAll('input, select');
                
                transportInputs.forEach(input => {
                    if (showTransport) {
                        input.setAttribute('required', '');
                    } else {
                        input.removeAttribute('required');
                    }
                });
                
                accommodationInputs.forEach(input => {
                    if (showAccommodation) {
                        input.setAttribute('required', '');
                    } else {
                        input.removeAttribute('required');
                    }
                });
            });
            
            // è§¦å‘ä¸€æ¬¡changeäº‹ä»¶ä»¥è®¾ç½®åˆå§‹çŠ¶æ€
            expenseTypeSelect.dispatchEvent(new Event('change'));
        }
    }

    // ç›‘å¬å‘ç¥¨ç±»å‹å˜åŒ–
    invoiceTypeSelect.addEventListener('change', updateExpenseTypeAndDetails);
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    updateExpenseTypeAndDetails();

    // åˆå§‹åŒ–ç°æœ‰çš„äº¤é€šæ˜ç»†é¡¹
    const transportItems = document.querySelectorAll('.transport-item');
    if (transportItems.length > 0) {
        transportItems.forEach(bindTransportTypeEvents);
    }

    // è¡¨å•æäº¤å¤„ç†
    const form = document.querySelector('form');
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
            showLoading('æ­£åœ¨ä¿å­˜...');  // ä¿®æ”¹åŠ è½½æç¤ºæ–‡æœ¬
            
            const formData = new FormData(this);
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (!response.ok) {
                throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
            }
            
            const data = await response.json();
            
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                alert('ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
        } finally {
            hideLoading();
        }
    });

    // è§£ææŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const parseBtn = document.getElementById('parse-btn');

    if (parseBtn) {
        parseBtn.addEventListener('click', async function() {
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }

            // åˆ¤æ–­æ–‡ä»¶ç±»å‹
            const fileExt = file.name.split('.').pop().toLowerCase();
            if (!['pdf', 'jpg', 'jpeg', 'png'].includes(fileExt)) {
                alert('ä»…æ”¯æŒPDFå’Œå›¾ç‰‡æ–‡ä»¶(jpg, jpeg, png)');
                return;
            }

            // è¯»å–æ–‡ä»¶ä¸º base64
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64Data = e.target.result.split(',')[1];
                
                try {
                    showLoading('æ­£åœ¨è§£æå‘ç¥¨...');  // ä¿®æ”¹åŠ è½½æç¤ºæ–‡æœ¬

                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    const formData = new FormData();
                    formData.append('file_data', base64Data);
                    formData.append('file_type', fileExt);

                    const response = await fetch('{% url "invoices:parse_invoice" %}', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success && data.words_result) {
                        // æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†
                        const modal = document.getElementById('parse-confirm-modal');
                        const result = data.words_result;
                        
                        // å¤„ç†é‡‘é¢
                        const amount = result.AmountInFiguers || '';
                        
                        // å¤„ç†æŠ¥é”€å†…å®¹
                        const commodityNames = result.CommodityName || [];
                        let details = '';
                        if (commodityNames.length === 1) {
                            details = commodityNames[0].Value || commodityNames[0].word || '';
                        } else if (commodityNames.length > 1) {
                            details = `${commodityNames[0].Value || commodityNames[0].word}ç­‰`;
                        }
                        
                        // å¡«å……æ¨¡æ€æ¡†æ•°æ®
                        document.getElementById('modal-invoice-num').textContent = result.InvoiceNum || '';
                        document.getElementById('modal-amount').textContent = amount;
                        document.getElementById('modal-date').textContent = result.InvoiceDate || '';
                        document.getElementById('modal-details').textContent = details;
                        document.getElementById('modal-remarks').textContent = result.Remarks || '';
                        
                        // æ˜¾ç¤ºæ¨¡æ€æ¡†
                        modal.classList.add('show');
                        console.log('æ˜¾ç¤ºæ¨¡æ€æ¡†');  // æ·»åŠ è°ƒè¯•æ—¥å¿—
                        
                        // ç»‘å®šå…³é—­äº‹ä»¶
                        const closeBtn = document.getElementById('close-parse');
                        const confirmBtn = document.getElementById('confirm-parse');
                        const cancelBtn = document.getElementById('cancel-parse');
                        
                        const hideModal = () => {
                            modal.classList.remove('show');
                            console.log('éšè—æ¨¡æ€æ¡†');  // æ·»åŠ è°ƒè¯•æ—¥å¿—
                        };
                        
                        closeBtn.onclick = hideModal;
                        cancelBtn.onclick = hideModal;
                        confirmBtn.onclick = function() {
                            // å¡«å……è¡¨å•
                            document.getElementById('invoice_number').value = result.InvoiceNum || '';
                            document.getElementById('amount').value = amount;
                            document.getElementById('details').value = details;
                            document.getElementById('remarks').value = result.Remarks || '';
                            
                            // å¤„ç†æ—¥æœŸæ ¼å¼
                            const dateMatch = result.InvoiceDate.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                            if (dateMatch) {
                                const [_, year, month, day] = dateMatch;
                                const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                document.getElementById('invoice_date').value = formattedDate;
                            }
                            
                            hideModal();
                        };
                    } else {
                        alert('å‘ç¥¨è§£æå¤±è´¥ï¼š' + (data.error_msg || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    alert('å‘ç¥¨è§£æå¤±è´¥ï¼š' + error.message);
                } finally {
                    hideLoading();
                }
            };

            reader.readAsDataURL(file);
        });
    }
});

// å®šä¹‰åº§ä½ç±»å‹æ˜ å°„
const seatTypeOptions = {
    TRAIN: [
        { value: 'TRAIN_SECOND', text: 'é«˜é“äºŒç­‰åº§' },
        { value: 'TRAIN_FIRST', text: 'é«˜é“ä¸€ç­‰åº§' },
        { value: 'TRAIN_BUSINESS', text: 'å•†åŠ¡åº§' }
    ],
    PLANE: [
        { value: 'PLANE_ECONOMY', text: 'ç»æµèˆ±' },
        { value: 'PLANE_BUSINESS', text: 'å•†åŠ¡èˆ±' }
    ]
};

// æ›´æ–°åº§ä½ç±»å‹é€‰é¡¹
function updateSeatTypeOptions(transportSelect) {
    const transportItem = transportSelect.closest('.transport-item');
    const seatTypeGroup = transportItem.querySelector('.seat-type-group');
    const seatTypeSelect = transportItem.querySelector('.seat-type');
    const transportType = transportSelect.value;

    if (transportType === 'TRAIN' || transportType === 'PLANE') {
        seatTypeGroup.style.display = 'block';
        seatTypeSelect.required = true;
        
        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        seatTypeSelect.innerHTML = '';
        
        // æ·»åŠ æ–°é€‰é¡¹
        seatTypeOptions[transportType].forEach(option => {
            const optionElement = new Option(option.text, option.value);
            seatTypeSelect.add(optionElement);
        });
    } else {
        // å¯¹äºå…¶ä»–äº¤é€šæ–¹å¼ï¼Œéšè—åº§ä½ç±»å‹é€‰æ‹©
        seatTypeGroup.style.display = 'none';
        seatTypeSelect.required = false;
    }
}

// ä¸ºç°æœ‰å’Œæ–°å¢çš„äº¤é€šæ˜ç»†é¡¹ç»‘å®šäº‹ä»¶
function bindTransportTypeEvents(transportItem) {
    const transportSelect = transportItem.querySelector('.transport-type');
    transportSelect.addEventListener('change', function() {
        updateSeatTypeOptions(this);
    });
    // åˆå§‹åŒ–åº§ä½ç±»å‹é€‰é¡¹
    updateSeatTypeOptions(transportSelect);
}

// åŠ è½½æç¤ºå‡½æ•°
function showLoading(text = 'åŠ è½½ä¸­...') {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-overlay';
    loadingDiv.innerHTML = `
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">${text}</div>
        </div>
    `;
    document.body.appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.getElementById('loading-overlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}
</script>
{% endblock %} 