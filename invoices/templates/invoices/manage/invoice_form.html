{% extends 'invoices/manage/base.html' %}

{% block title %}{% if invoice %}编辑{% else %}添加{% endif %}发票 - 发票管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{% if invoice %}编辑{% else %}添加{% endif %}发票</h1>
</div>

<div class="card">
    <form method="post" enctype="multipart/form-data" class="form">
        {% csrf_token %}
        <div class="form-grid">
            <div class="form-group">
                <label for="invoice_number">发票号*</label>
                <input type="text" id="invoice_number" name="invoice_number" required
                       value="{{ invoice.invoice_number|default:'' }}">
            </div>

            <div class="form-group">
                <label for="invoice_type">发票类型*</label>
                <select id="invoice_type" name="invoice_type" required>
                    <option value="DAILY" {% if invoice.invoice_type == 'DAILY' %}selected{% endif %}>日常发票</option>
                    <option value="TRAVEL" {% if invoice.invoice_type == 'TRAVEL' %}selected{% endif %}>差旅发票</option>
                </select>
            </div>

            <div class="form-group">
                <label for="expense_type">费用类型*</label>
                <select id="expense_type" name="expense_type" required>
                    {% for type in expense_types %}
                    <option value="{{ type.id }}" {% if invoice.expense_type_id == type.id %}selected{% endif %}>
                        {{ type.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="amount">金额*</label>
                <input type="number" id="amount" name="amount" step="0.01" required
                       value="{{ invoice.amount|default:'' }}">
            </div>

            <div class="form-group">
                <label for="invoice_date">发票日期*</label>
                <input type="date" id="invoice_date" name="invoice_date" required
                       value="{{ invoice.invoice_date|date:'Y-m-d'|default:'' }}">
            </div>

            <div class="form-group">
                <label for="reimbursement_person">报销人*</label>
                <input type="text" id="reimbursement_person" name="reimbursement_person" required
                       value="{{ invoice.reimbursement_person|default:'' }}">
            </div>

            <div class="form-group full-width">
                <label for="details">发票明细</label>
                <textarea id="details" name="details" rows="4">{{ invoice.details|default:'' }}</textarea>
            </div>

            <div class="form-group">
                <label for="image">发票照片{% if not invoice %}*{% endif %}</label>
                {% if invoice.image %}
                <div class="current-image">
                    <img src="{{ invoice.image.url }}" alt="当前发票照片">
                </div>
                {% endif %}
                <input type="file" id="image" name="image" accept="image/*" {% if not invoice %}required{% endif %}>
            </div>
        </div>

        <div id="travel_details" style="display: none;">
            <h3>差旅信息</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="traveler">出差人*</label>
                    <input type="text" id="traveler" name="traveler" 
                           value="{{ invoice.travelinvoice.traveler|default:'' }}">
                </div>

                <div class="form-group">
                    <label for="start_date">开始日期*</label>
                    <input type="date" id="start_date" name="start_date"
                           value="{{ invoice.travelinvoice.start_date|date:'Y-m-d'|default:'' }}">
                </div>

                <div class="form-group">
                    <label for="end_date">结束日期*</label>
                    <input type="date" id="end_date" name="end_date"
                           value="{{ invoice.travelinvoice.end_date|date:'Y-m-d'|default:'' }}">
                </div>

                <div class="form-group">
                    <label for="destination">出差地点*</label>
                    <input type="text" id="destination" name="destination"
                           value="{{ invoice.travelinvoice.destination|default:'' }}">
                </div>

                <div class="form-group">
                    <label for="expense_category">费用类别*</label>
                    <select id="expense_category" name="expense_category">
                        <option value="TRANSPORT" {% if invoice.travelinvoice.expense_category == 'TRANSPORT' %}selected{% endif %}>交通</option>
                        <option value="ACCOMMODATION" {% if invoice.travelinvoice.expense_category == 'ACCOMMODATION' %}selected{% endif %}>住宿</option>
                        <option value="OTHER" {% if invoice.travelinvoice.expense_category == 'OTHER' %}selected{% endif %}>其他</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">保存</button>
            <a href="{% url 'invoices:manage_invoice_list' %}" class="btn">取消</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const invoiceTypeSelect = document.getElementById('invoice_type');
    const travelDetails = document.getElementById('travel_details');
    const travelInputs = travelDetails.querySelectorAll('input, select');

    function toggleTravelFields() {
        const isTravel = invoiceTypeSelect.value === 'TRAVEL';
        travelDetails.style.display = isTravel ? 'block' : 'none';
        travelInputs.forEach(input => {
            input.required = isTravel;
        });
    }

    invoiceTypeSelect.addEventListener('change', toggleTravelFields);
    toggleTravelFields();
});
</script>
{% endblock %} 