{% extends 'invoices/manage/base.html' %}
{% load static %}

{% block title %}æŠ¥è´¦ç®¡ç† - 525å®éªŒå®¤å‘ç¥¨ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h1>æŠ¥è´¦ç®¡ç†</h1>
    <div class="page-actions">
        <!-- <a href="#" class="btn btn-primary" onclick="showNewReimbursementModal()">
            <span class="icon">â•</span>æ–°å»ºæŠ¥è´¦
        </a> -->
        <button class="btn btn-primary" onclick="showNewReimbursementModal()">
            <span class="icon">â•</span>æ–°å»ºæŠ¥è´¦
        </button>
    </div>
</div>

<div class="filter-bar">
    <form method="get" class="filter-form">
        <div class="form-group">
            <select name="type">
                <option value="">æ‰€æœ‰ç±»å‹</option>
                <option value="DAILY" {% if request.GET.type == 'DAILY' %}selected{% endif %}>æ—¥å¸¸æŠ¥é”€</option>
                <option value="TRAVEL" {% if request.GET.type == 'TRAVEL' %}selected{% endif %}>å·®æ—…æŠ¥é”€</option>
            </select>
        </div>
        <div class="form-group">
            <select name="status">
                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                <option value="SUBMITTED" {% if request.GET.status == 'SUBMITTED' %}selected{% endif %}>å·²æäº¤</option>
                <option value="COMPLETED" {% if request.GET.status == 'COMPLETED' %}selected{% endif %}>å·²æŠ¥è´¦</option>
            </select>
        </div>
        <button type="submit" class="btn btn-filter">
            <span class="icon">ğŸ”</span>ç­›é€‰
        </button>
    </form>
</div>

<div class="card">
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>æŠ¥è´¦æ—¶é—´</th>
                    <th>æŠ¥è´¦ç±»å‹</th>
                    <th>å‘ç¥¨æ•°é‡</th>
                    <th>æ€»é‡‘é¢</th>
                    <th>çŠ¶æ€</th>
                    <th>å¤‡æ³¨</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for record in records %}
                <tr data-record-id="{{ record.id }}" class="clickable-row">
                    <td>{{ record.reimbursement_date|date:"Y-m-d" }}</td>
                    <td>{{ record.get_record_type_display }}</td>
                    <td>{{ record.invoices.count }}</td>
                    <td>Â¥{{ record.total_amount|floatformat:2 }}</td>
                    <td>
                        <span class="status-badge {{ record.status|lower }}">
                            {{ record.get_status_display }}
                        </span>
                    </td>
                    <td>{{ record.remarks|default:"-" }}</td>
                    <td class="actions">
                        {% if record.status == 'SUBMITTED' %}
                        <button class="btn-icon" onclick="markAsCompleted({{ record.id }})" title="æ ‡è®°ä¸ºå·²æŠ¥è´¦">
                            âœ“
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="empty-message">æš‚æ— æŠ¥è´¦è®°å½•</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- æ–°å»ºæŠ¥è´¦æ¨¡æ€æ¡† -->
<div id="newReimbursementModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ–°å»ºæŠ¥è´¦</h3>
            <button type="button" class="close-btn" onclick="closeNewReimbursementModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="reimbursementForm" method="post" action="{% url 'invoices:manage_reimbursement_add' %}">
                {% csrf_token %}
                <div class="form-group filter-form">
                    <label>æŠ¥è´¦ç±»å‹*</label>
                    <select name="record_type" required>
                        <option value="DAILY">æ—¥å¸¸æŠ¥é”€</option>
                        <option value="TRAVEL">å·®æ—…æŠ¥é”€</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©å‘ç¥¨*</label>
                    <div class="invoice-selector">
                        <!-- è¿™é‡Œå°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½æœªæŠ¥è´¦çš„å‘ç¥¨åˆ—è¡¨ -->
                    </div>
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <textarea name="remarks" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">æäº¤æŠ¥è´¦</button>
                    <button type="button" class="btn" onclick="closeNewReimbursementModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'invoices/css/manage/reimbursement.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'invoices/js/reimbursement.js' %}"></script>
<script>
    // åˆå§‹åŒ–åŠ¨æ€ URL
    initializeUrls({
        unreimbursedInvoices: '{% url "invoices:manage_unreimbursed_invoices" %}'
    });
</script>
{% endblock %} 